@{
    ViewData["Title"] = "Home Page"; 
}

<style>
    .hide-scrollbar::-webkit-scrollbar {
        display: none;
    }

    .hide-scrollbar {
        -ms-overflow-style: none;
        scrollbar-width: none;
    }
</style>

<div class="grid grid-cols-1 xl:grid-cols-12 gap-6 items-start relative">

    <div class="col-span-1 xl:col-span-8 space-y-6">

        <!-- Stories Rail -->
        @* @await Component.InvokeAsync("StoryRail") *@
        <partial name="Partials/_StoryRail" model="Model.Stories" />

        @* <partial name="Partials/_Stories" /> *@

        <!-- Create Post -->
        <partial name="Partials/_CreatePost" />

        <!-- Posts -->
        <partial name="Partials/_PostCard" model="Model.Posts" />
    </div>

    <partial name="Partials/_RightSidebar" />
</div>

<!-- Modals -->
<partial name="Partials/_CreateStoryModal" />
<partial name="Partials/_StoryViewer" />





@section Scripts {
    <script>
        // ==========================================
        // Story Viewer Variables
        // ==========================================
        let currentUserId = null;
        let currentUserStories = [];
        let currentStoryIndex = 0;
        let progressInterval = null;

        // ==========================================
        // 1. Logic for Story Scroll (Handles Left/Right)
        // ==========================================
        function scrollStories(direction) {
            const container = document.getElementById('storiesContainer');
            const scrollStep = 130;

            if (direction === 'left') {
                container.scrollBy({ left: -scrollStep, behavior: 'smooth' });
            } else {
                container.scrollBy({ left: scrollStep, behavior: 'smooth' });
            }
        }

        // ==========================================
        // 2. Story Modal Functions
        // ==========================================
        window.openStoryModal = function() {
            const modal = document.getElementById('storyModal');
            if (modal) {
                modal.classList.remove('hidden');
                document.body.style.overflow = 'hidden';
            }
        };

        window.closeStoryModal = function() {
            const modal = document.getElementById('storyModal');
            if (modal) {
                modal.classList.add('hidden');
                document.body.style.overflow = '';
            }
        };

        // ==========================================
        // 3. Story Viewer Functions
        // ==========================================
        window.openStoryViewer = async function(userId) {
            console.log('openStoryViewer called with userId:', userId);
            try {
                const response = await fetch(`/Stories/GetUserStories?userId=${userId}`);

                if (!response.ok) {
                    console.error('Response not OK:', response.status);
                    return;
                }

                const stories = await response.json();
                console.log('Stories received:', stories);

                if (stories && stories.length > 0) {
                    currentUserId = userId;
                    currentUserStories = stories;
                    currentStoryIndex = 0;
                    showStory(0);
                    document.getElementById('storyViewerModal').classList.remove('hidden');
                    document.body.style.overflow = 'hidden';
                    startProgress();
                } else {
                    SohbaApp.toast('No stories to show', 'info');
                }
            } catch (error) {
                console.error('Error loading stories:', error);
                SohbaApp.toast('Failed to load stories', 'error');
            }
        };

         function showStory(index) {
            if (index < 0 || index >= currentUserStories.length) {
                closeStoryViewer();
                return;
            }

            currentStoryIndex = index;
            const story = currentUserStories[index];
            console.log('Showing story:', story);

            // Update UI
            document.getElementById('storyUserName').textContent = story.userName;
            document.getElementById('storyUserAvatar').src = story.userProfilePicture ||
                `https://ui-avatars.com/api/?name=${story.userName}&background=345e69&color=fff`;

            // Time
            const timeAgo = getTimeAgo(story.createdAt);
            document.getElementById('storyTime').textContent = timeAgo;

            // Viewers
            document.getElementById('storyViewersCount').textContent = story.viewersCount || 0;

            // Load content (media or text)
            const contentDiv = document.getElementById('storyContent');

            if (story.mediaUrl) {
                const fullUrl = window.location.origin + story.mediaUrl;
                if (story.mediaType === 'video') {
                        contentDiv.innerHTML = `<video src="${fullUrl}" class="max-h-full max-w-full" autoplay controls></video>`;
                } else {
                        contentDiv.innerHTML = `<img src="${fullUrl}" class="max-h-full max-w-full object-contain">`;

                }
            } else {
                // في حالة عدم وجود media، اعرض الـ content كنص
                contentDiv.innerHTML = `
                    <div class="flex items-center justify-center h-full w-full p-8">
                        <div class="text-white text-2xl text-center max-w-2xl bg-black/30 p-8 rounded-2xl backdrop-blur-sm">
                            ${story.content || ''}
                        </div>
                    </div>
                `;
            }

            // Mark as viewed
            fetch('/Stories/MarkAsViewed', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ storyId: story.id })
            });
        }

        function startProgress() {
            let progress = 0;
            progressInterval = setInterval(() => {
                progress += 1;
                const progressBar = document.getElementById('storyProgress');
                if (progressBar) {
                    progressBar.style.width = progress + '%';
                }

                if (progress >= 100) {
                    clearInterval(progressInterval);
                    navigateStory('next');
                }
            }, 50); // 5 seconds total
        }

        window.navigateStory = function(direction) {
            clearInterval(progressInterval);

            if (direction === 'next') {
                if (currentStoryIndex < currentUserStories.length - 1) {
                    showStory(currentStoryIndex + 1);
                    startProgress();
                } else {
                    closeStoryViewer();
                }
            } else if (direction === 'prev') {
                if (currentStoryIndex > 0) {
                    showStory(currentStoryIndex - 1);
                    startProgress();
                }
            }
        };

        window.closeStoryViewer = function() {
            document.getElementById('storyViewerModal').classList.add('hidden');
            document.body.style.overflow = '';
            clearInterval(progressInterval);
            currentUserId = null;
            currentUserStories = [];
        };

        // Helper function for time ago
        function getTimeAgo(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMins / 60);
            const diffDays = Math.floor(diffHours / 24);

            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return diffMins + 'm ago';
            if (diffHours < 24) return diffHours + 'h ago';
            return diffDays + 'd ago';
        }

        // Keyboard navigation
        document.addEventListener('keydown', function(e) {
            const modal = document.getElementById('storyViewerModal');
            if (modal && !modal.classList.contains('hidden')) {
                if (e.key === 'ArrowLeft') {
                    navigateStory('prev');
                } else if (e.key === 'ArrowRight') {
                    navigateStory('next');
                } else if (e.key === 'Escape') {
                    closeStoryViewer();
                }
            }
        });

        // ==========================================
        // 4. Dropdown Menu Functions
        // ==========================================
        function toggleMenu(menuId) {
            const menu = document.getElementById(menuId);
            // إغلاق أي منيو مفتوحة تانية عشان ميبقاش فيه زحمة
            document.querySelectorAll('[id^="menu-"]').forEach(el => {
                if (el.id !== menuId) el.classList.add('hidden');
            });
            menu.classList.toggle('hidden');
        }

        // إغلاق المنيو عند الضغط في أي مكان خارجها
        window.addEventListener('click', function(event) {
            if (!event.target.closest('button')) {
                document.querySelectorAll('[id^="menu-"]').forEach(el => {
                    el.classList.add('hidden');
                });
            }
        });

        // ==========================================
        // 5. Comment Modal Functions (Legacy)
        // ==========================================
        function openCommentModal(imgUrl, authorName, content, time) {
            // 1. Update Modal Elements with Real Data
            const modalImg = document.getElementById('modalImg');
            const modalUserName = document.getElementById('modalUserName');
            const modalUserAvatar = document.getElementById('modalUserAvatar');
            const modalDescription = document.getElementById('modalDescription');
            const modalPostTime = document.getElementById('modalPostTime');

            if(modalImg) modalImg.src = imgUrl || '';
            if(modalUserName) modalUserName.innerText = authorName;
            if(modalUserAvatar) modalUserAvatar.src = `https://ui-avatars.com/api/?name=${authorName}&background=345e69&color=fff`;
            if(modalDescription) modalDescription.innerText = content;
            if(modalPostTime) modalPostTime.innerText = "Published at " + time;

            // 2. Show Modal
            document.getElementById('commentModal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        function closeCommentModal() {
            document.getElementById('commentModal').classList.add('hidden');
            document.body.style.overflow = 'auto';
        }
    </script>
}
